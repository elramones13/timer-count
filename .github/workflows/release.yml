name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest]

    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Install dependencies (macOS only)
        run: npm ci

      - name: Build the app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Timer Count v__VERSION__'
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: false
          prerelease: false
          args: --target universal-apple-darwin

      - name: Upload signature file
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          SIG_FILE=$(find src-tauri/target/universal-apple-darwin/release/bundle/macos -name "*.app.tar.gz.sig" | head -n 1)
          if [ -n "$SIG_FILE" ]; then
            echo "Found signature file: $SIG_FILE"
            gh release upload "$TAG_NAME" "$SIG_FILE" --clobber --repo ${{ github.repository }}
          else
            echo "WARNING: No .sig file found"
          fi

      - name: Generate and upload latest.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Wait a bit for signature upload
          sleep 5

          TAG_NAME="${{ github.ref_name }}"
          VERSION="${TAG_NAME#v}"

          echo "Fetching release information for tag: $TAG_NAME"

          # Get release info and assets
          RELEASE_INFO=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG_NAME}")

          # Get list of assets
          ASSETS=$(echo "$RELEASE_INFO" | jq -r '.assets[] | "\(.name)"')
          echo "Available assets in release:"
          echo "$ASSETS"

          # Find the .app.tar.gz and .sig files from the release assets
          APP_TAR_GZ=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".app.tar.gz") and (endswith(".sig") | not)) | .name' | head -n 1)
          SIG_FILE=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | endswith(".app.tar.gz.sig")) | .name' | head -n 1)

          if [ -z "$APP_TAR_GZ" ]; then
            echo "ERROR: Could not find .app.tar.gz file in release assets"
            echo "Found .app.tar.gz: $APP_TAR_GZ"
            exit 1
          fi

          echo "Found app bundle: $APP_TAR_GZ"

          # Check if signature file exists
          if [ -z "$SIG_FILE" ]; then
            echo "WARNING: No .sig file found - bundle was not signed"
            echo "This is expected if TAURI_SIGNING_PRIVATE_KEY is not configured"
            echo "The app will work but auto-updates will not verify signatures"
            SIGNATURE=""
          else
            echo "Found signature: $SIG_FILE"
            # Download the signature file content
            SIG_URL=$(echo "$RELEASE_INFO" | jq -r ".assets[] | select(.name == \"$SIG_FILE\") | .browser_download_url")
            SIGNATURE=$(curl -sL "$SIG_URL")
          fi

          # Build the download URL
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${APP_TAR_GZ}"

          # Create latest.json
          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See release notes at https://github.com/${{ github.repository }}/releases/tag/${TAG_NAME}",
            "pub_date": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${SIGNATURE}",
                "url": "${DOWNLOAD_URL}"
              },
              "darwin-x86_64": {
                "signature": "${SIGNATURE}",
                "url": "${DOWNLOAD_URL}"
              }
            }
          }
          EOF

          echo "Generated latest.json:"
          cat latest.json

          # Upload latest.json as release asset
          UPLOAD_URL=$(echo "$RELEASE_INFO" | jq -r .upload_url | sed 's/{?name,label}//')

          curl -X POST \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            "${UPLOAD_URL}?name=latest.json" \
            --data-binary @latest.json

          echo "SUCCESS: latest.json uploaded successfully"
